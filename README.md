# DPRank

## About
This repository presents an implementation of algorithmic support for dynamic pricing based on surrogate modeling of ticket demand for a passenger railway company on open data. The data for this study was collected by our team from open sources of online rail ticket sales.

Since the study also includes incremental learning of the obtained surrogate models, the initial data were divided into two datasets, which are called old and new data in the notebook, respectively. In this notebook, a surrogate model was built on the combined old and new data. For incremental learning, a surrogate demand model can be built on old data and incrementally updated with new data.

The data files in the root directory are obtained because of experiments on building a surrogate model on old data and its incremental learning on new data. The All_data (All_data.zip) folder contains files obtained because of experiments on building a surrogate model using a combined dataset of old and new data.
To build a surrogate model from the merged data, use the algorithm in the All_data notebook paragraph. To build a surrogate model only from old data for its further incremental training, the algorithm in the All_data paragraph should not be used.

### Description of data files: 

* data.csv (data.zip) - Old data
* new_data.csv (new_data.zip)- New data
* mean_prices.csv - Average prices
* mean_demand.csv - Average demand
* r2_df.csv – Values of the coefficient of determination of the linearized model
* pred_demand_df.csv - linearized demand obtained from the simulation
* relined_demand_df.csv - demand received because of simulation
* model_df.csv - ensemble of models
* A_df.csv - *a* coefficients of models
* B_df.csv - *b* model coefficients
* *Train number* _ *Day of week* _ *popsize*.npy – the data obtained from the optimization contains the optimal prices, model errors generated, and revenue generated by the optimization.
* new_*file_name*.csv – files obtained because of incremental learning.

The structure of the collected and used [data](https://github.com/AlgoMathITMO/DPRank/blob/main/data.zip "Data structure") is shown in table 1.

Table 1: The structure of the data collected and used.
<p align="center">
  <img src="https://github.com/AlgoMathITMO/DPRank/blob/main/Tables/data_file_info.jpg">
</p>

## Experimental results

### Obtaining a Model of Price Elasticity of Demand

As a result of approximation by a power function of the existing price elasticity of demand, its description is formed, as shown in Figure 1.

![Figure 1. Price elasticity of demand for Type A train](https://github.com/AlgoMathITMO/Railways_surrogate_modeling/blob/main/All_data/Fig/A_752A/A%20Surrogate%20model%20of%20price%20elasticity%20of%20demand.jpg "Figure 1. Price elasticity of demand for Type A train.")

The parameters of this model are represented by the coefficients a and b, as well as the absolute and relative errors.

The model parameters are shown in Figure 2.

![Figure 2. Parameters of the linearized model of price elasticity of demand for a Type A train.](https://github.com/AlgoMathITMO/Railways_surrogate_modeling/blob/main/All_data/Fig/A_752A/A%20Model_parameters.jpg "Figure 2. Parameters of the linearized model of price elasticity of demand for a Type A train.")

The histogram of the distribution of model errors is shown in Figure 3.

![Figure 3. Model errors distribution histogram for Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Histogram%20of%20distribution%20of%20errors.jpg "Figure 3. Model errors distribution histogram for Type A train.")

In Figure 3, the ADF results are the results of the Dickey-Fuller test for stationarity.

### Getting bounds for optimization

The distribution of prices by service classes and their boundaries are shown in Figure 4.

![Figure 4. Distribution of prices by class of service for a Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Price%20histogram%20with%20price%20ranges%20of%20classes.jpg "Figure 4. Distribution of prices by class of service for a Type A train.")

Service classes provided:
* B1 — First;
* B2 — Economy+;
* C1 — Business;
* C2 — Economy.

Since the real price boundaries of the classes are unknown, the lines in this figure represent the price boundaries that we obtained. The dashed line shows the real average prices by class of service. These bounds are further used for optimization.

#### Validation

Before optimization, the results of generating model errors from the experimental distribution were validated. The validation results are shown in Figure 5.

![Figure 5. Validation results of the model error generation algorithm for Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Surrogate%20model%20validation%20results.jpg "Figure 5. Validation results of the model error generation algorithm for Type A train.")

### Optimization

The optimization results are shown in the [Figures](https://github.com/AlgoMathITMO/DPRank/tree/main/All_data/Fig/A_752A "A Type train Figures") below. In these figures, the line shows the corresponding average values of the quantities, the semi-transparent area indicates the confidence interval.

#### Prices

The prices obtained as a result of the optimization and the prices of the passenger railway company are shown in Figure 6.

![Figure 6. Comparison of prices based on optimization results for Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Average%20prices%2Bconfidence%20interval.jpg "Figure 6. Comparison of prices based on optimization results for Type A train.")

#### Demand

The demand calculated from the prices received from the optimizer and the demand of the passenger railway company is shown in Figure 7.

![Figure 7. Comparison of the demand obtained by optimization and the demand of a passenger railway company for Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Average%20demand%2Bconfidence%20interval.jpg "Figure 7. Comparison of the demand obtained by optimization and the demand of a passenger railway company for Type A train.")

The limits on the demand of the passenger railway company and the demand achieved as a result of optimization are shown in Table 2.

Table 2: otal demand for tickets received by the optimizer by class of service for τ =
2, . . . , 14.
<p align="center">
  <img src="https://github.com/AlgoMathITMO/DPRank/blob/main/Tables/optimizer_demand.jpg">
</p>

#### Revenue

The revenue received as a result of optimization and the revenue of the passenger railway company is shown in Figure 8.

![Figure 8. Comparison of the revenue obtained by optimization and the revenue of a passenger railway company for a Type A train.](https://github.com/AlgoMathITMO/DPRank/blob/main/All_data/Fig/A_752A/A%20Average%20revenue%2Bconfidence%20interval.jpg "Figure 8. Comparison of the revenue obtained by optimization and the revenue of a passenger railway company for a Type A train.")

Numerical optimization results obtained from the [data](https://github.com/AlgoMathITMO/DPRank/tree/main/All_data/Opt_data "Optimization results for different trains") are shown in Table 3.

Table 3: Table 4: Summarized revenue (as the sum of revenue random variables for τ = 2, . . . , 14)
obtained via simulation and from the real-world Railways Company data (m and s stand
for the sample mean and sample standard deviation, correspondingly). The amounts in rubles
and percents are rounded to the nearest integer. Statistically significant revenue changes
are shown in magenta.
<p align="center">
  <img src="https://github.com/AlgoMathITMO/DPRank/blob/main/Tables/revenue_update.jpg">
</p>

Some other graphical results are presented at the [link](https://github.com/AlgoMathITMO/DPRank/tree/main/All_data/Fig/ "Graphic results").
